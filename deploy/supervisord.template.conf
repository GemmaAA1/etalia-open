[unix_http_server]
file=/tmp/supervisor.sock                       ; path to your socket file

[supervisord]
logfile={{ STACK_DIR }}/log/supervisord.log     ; supervisord log file
logfile_maxbytes=10MB                           ; maximum size of logfile before rotation
logfile_backups=5                               ; number of backed up logfiles
loglevel=info                                   ; info, debug, warn, trace
pidfile=/var/run/supervisord.pid                ; pidfile location
nodaemon=false                                  ; run supervisord as a daemon
minfds=1024                                     ; number of startup file descriptors
minprocs=200                                    ; number of process descriptors
user={{ USER }}                                 ; default user
childlogdir={{ STACK_DIR }}/log/                ; where child log files will live
environment=ENV_VARS_POSTACTIVATE

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

{% if 'apps' in ROLES %}
[program:gunicorn]
command={{ ENV_DIR }}/bin/gunicorn config.wsgi:application -c {{ STACK_DIR }}/{{ CONF_DIR }}/gunicorn.conf.py
directory={{ SOURCE_DIR }}
user={{ USER }}
autostart=true
autorestart=true
redirect_stderr=true
{% endif %}

{% if 'jobs' in ROLES %}
[program:celery-default]
command={{ ENV_DIR }}/bin/celery worker -A config -Q default --concurrency=10 -l INFO -n worker1-default-{{ STACK }}@%%h
directory={{ SOURCE_DIR }}
user={{ USER }}
numprocs=1
autostart=true
autorestart=true
startsecs=10
stopwaitsecs = 600
killasgroup=true
priority=998  ; if rabbitmq is supervised, set its priority higher so it starts first

[program:celery-consumers]
command={{ ENV_DIR }}/bin/celery worker -A config -Q consumers --concurrency=10 -l INFO -n worker1-consumers-{{ STACK }}@%%h
directory={{ SOURCE_DIR }}
user={{ USER }}
numprocs=1
autostart=true
autorestart=true
startsecs=10
stopwaitsecs = 600
killasgroup=true
priority=998  ; if rabbitmq is supervised, set its priority higher so it starts first

[program:celery-nlp]
command={{ ENV_DIR }}/bin/celery worker -A config -Q nlp --concurrency=10 -l INFO -n worker1-nlp-{{ STACK }}@%%h
directory={{ SOURCE_DIR }}
user={{ USER }}
numprocs=1
autostart=true
autorestart=true
startsecs=10
stopwaitsecs = 600
killasgroup=true
priority=998  ; if rabbitmq is supervised, set its priority higher so it starts first

[program:celery-beat]
command={{ ENV_DIR }}/bin/celery beat -A config -s {{ STACK_DIR }}/{{ CONF_DIR }}/schedule-beat.db -l INFO
directory={{ SOURCE_DIR }}
user={{ USER }}
numprocs=1
autostart=true
autorestart=true
startsecs=10
stopwaitsecs = 600
killasgroup=true
priority=998  ; if rabbitmq is supervised, set its priority higher so it starts first

[program:rabbitmq]
command=/usr/sbin/rabbitmq-server
numprocs=1
autostart=true
autorestart=true
priority=990

;[group:celery]
;programs=celery-default,celery-nlp,celery-consumers,celery-beat
;priority=998
{% endif %}